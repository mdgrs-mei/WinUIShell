using System.Text;
using WinUIShell.Server;

namespace WinUIShell.Generator;

internal class ObjectDef
{
    private readonly Api.ObjectDef _apiObjectDef;
    private readonly TypeDef? _baseType;
    private readonly ObjectDef? _parentObjectDef;

    private readonly List<TypeDef> _interfaces = [];
    private readonly List<PropertyDef> _staticProperties = [];
    private readonly List<PropertyDef> _instanceProperties = [];
    private readonly List<MethodDef> _constructors = [];
    private readonly List<MethodDef> _staticMethods = [];
    private readonly List<MethodDef> _instanceMethods = [];
    private readonly List<ObjectDef> _nestedObjects = [];

    public TypeDef Type { get; }

    public ObjectDef(Api.ObjectDef apiObjectDef, ObjectDef? parentObjectDef = null)
    {
        _apiObjectDef = apiObjectDef;
        _parentObjectDef = parentObjectDef;

        Type = new TypeDef(_apiObjectDef.Type);
        Type.AlwaysReturnSystemInterfaceName = Type.IsSystemInterface;

        if (_apiObjectDef.BaseType is not null)
        {
            _baseType = new TypeDef(_apiObjectDef.BaseType);
        }

        if (_apiObjectDef.Interfaces is not null)
        {
            foreach (var interfaceType in _apiObjectDef.Interfaces)
            {
                _interfaces.Add(new TypeDef(interfaceType));
            }
        }
        if (_apiObjectDef.StaticProperties is not null)
        {
            foreach (var property in _apiObjectDef.StaticProperties)
            {
                _staticProperties.Add(new PropertyDef(property, this, MemberDefType.Static));
            }
        }
        if (_apiObjectDef.InstanceProperties is not null)
        {
            foreach (var property in _apiObjectDef.InstanceProperties)
            {
                _instanceProperties.Add(new PropertyDef(property, this, MemberDefType.Instance));
            }
        }
        if (_apiObjectDef.Constructors is not null)
        {
            foreach (var constructor in _apiObjectDef.Constructors)
            {
                _constructors.Add(new MethodDef(constructor, this, MemberDefType.Constructor));
            }
        }
        if (_apiObjectDef.StaticMethods is not null)
        {
            foreach (var method in _apiObjectDef.StaticMethods)
            {
                _staticMethods.Add(new MethodDef(method, this, MemberDefType.Static));
            }
        }
        if (_apiObjectDef.InstanceMethods is not null)
        {
            foreach (var method in _apiObjectDef.InstanceMethods)
            {
                _instanceMethods.Add(new MethodDef(method, this, MemberDefType.Instance));
            }
        }
        if (_apiObjectDef.NestedTypes is not null)
        {
            foreach (var nestedType in _apiObjectDef.NestedTypes)
            {
                _nestedObjects.Add(new ObjectDef(nestedType, this));
            }
        }
    }

    public bool IsSupported()
    {
        return Type.IsSupported() && !Type.IsRpcSupportedType && !Type.IsObject;
    }

    public bool ContainsSignature(PropertyDef propertyDef)
    {
        string signature = propertyDef.GetSignatureId();
        foreach (var property in _staticProperties)
        {
            if (property.GetSignatureId() == signature)
            {
                return true;
            }
        }
        foreach (var property in _instanceProperties)
        {
            if (property.GetSignatureId() == signature)
            {
                return true;
            }
        }
        return false;
    }

    public bool ContainsSignature(MethodDef methodDef)
    {
        string signature = methodDef.GetSignatureId();
        foreach (var method in _constructors)
        {
            if (method.GetSignatureId() == signature)
            {
                return true;
            }
        }
        foreach (var method in _staticMethods)
        {
            if (method.GetSignatureId() == signature)
            {
                return true;
            }
        }
        foreach (var method in _instanceMethods)
        {
            if (method.GetSignatureId() == signature)
            {
                return true;
            }
        }
        return false;
    }

    public string GetSourceCodeFileName()
    {
        var fullName = _apiObjectDef.FullName.Split(',')[0];
        return $"WinUIShell.{fullName}.g.cs";
    }

    public string Generate()
    {
        var codeWriter = new CodeWriter();

        var ns = Generator.GetTargetNamespace(_apiObjectDef.Namespace);
        codeWriter.Append($$"""
            // <auto-generated/>
            #nullable enable

            using WinUIShell;
            using WinUIShell.Common;

            namespace {{ns}};

            """);

        Generate(codeWriter);
        return codeWriter.ToString();
    }

    private void Generate(CodeWriter codeWriter)
    {
        if (Type.IsInterface)
        {
            GenerateInterface(codeWriter);
            GenerateInterfaceImpl(codeWriter);
        }
        else
        {
            GenerateClass(codeWriter);
        }
    }

    private void GenerateInterface(CodeWriter codeWriter)
    {
        string genericArgumentsExpression = Type.GetGenericArgumentsExpression(_parentObjectDef?.Type.GenericArguments);
        StringBuilder baseTypeExpression = new();
        foreach (var interfaceType in _interfaces)
        {
            if (interfaceType.IsSupported())
            {
                if (baseTypeExpression.Length == 0)
                {
                    _ = baseTypeExpression.Append(" : ");
                }
                else
                {
                    _ = baseTypeExpression.Append(", ");
                }
                _ = baseTypeExpression.Append(interfaceType.GetName());
            }
        }

        if (baseTypeExpression.Length == 0)
        {
            _ = baseTypeExpression.Append($" : IWinUIShellObject");
        }

        if (Type.IsSystemInterface)
        {
            _ = baseTypeExpression.Append($", {Type.GetSystemInterfaceName()}");
        }

        codeWriter.Append($$"""
            public interface {{_apiObjectDef.Name}}{{genericArgumentsExpression}}{{baseTypeExpression}}
            {
            """);

        if (!Type.IsSystemInterface)
        {
            codeWriter.IncrementIndent();

            foreach (var method in _constructors)
            {
                if (!method.IsSupported())
                    continue;

                codeWriter.AppendAndReserveNewLine($$"""
                    {{method.GetConstructorSignatureExpression(_apiObjectDef.Name)}}
                    """);
            }

            foreach (var property in _staticProperties)
            {
                if (!property.IsSupported())
                    continue;

                codeWriter.Append($$"""
                    {{property.GetSignatureExpression()}}
                    {
                    """);
                codeWriter.IncrementIndent();

                if (property.CanRead)
                {
                    codeWriter.Append($$"""
                        get;
                        """);
                }

                if (property.CanWrite)
                {
                    codeWriter.Append($$"""
                        set;
                        """);
                }

                codeWriter.DecrementIndent();
                codeWriter.AppendAndReserveNewLine("}");
            }

            foreach (var property in _instanceProperties)
            {
                if (!property.IsSupported())
                    continue;

                codeWriter.Append($$"""
                    {{property.GetSignatureExpression()}}
                    {
                    """);
                codeWriter.IncrementIndent();

                if (property.CanRead)
                {
                    codeWriter.Append($$"""
                        get;
                        """);
                }

                if (property.CanWrite)
                {
                    codeWriter.Append($$"""
                        set;
                        """);
                }

                codeWriter.DecrementIndent();
                codeWriter.AppendAndReserveNewLine("}");
            }

            foreach (var method in _staticMethods)
            {
                if (!method.IsSupported())
                    continue;

                codeWriter.AppendAndReserveNewLine($$"""
                    {{method.GetSignatureExpression()}};
                    """);
            }

            foreach (var method in _instanceMethods)
            {
                if (!method.IsSupported())
                    continue;

                codeWriter.AppendAndReserveNewLine($$"""
                    {{method.GetSignatureExpression()}};
                    """);
            }

            foreach (var nestedObject in _nestedObjects)
            {
                nestedObject.Generate(codeWriter);
            }

            codeWriter.DecrementIndent();
        }
        codeWriter.AppendAndReserveNewLine("}");
    }

    private void GenerateClass(CodeWriter codeWriter)
    {
        string genericArgumentsExpression = Type.GetGenericArgumentsExpression(_parentObjectDef?.Type.GenericArguments);

        StringBuilder baseTypeExpression = new();
        if (_baseType is not null && _baseType.IsSupported())
        {
            _ = baseTypeExpression.Append($" : {_baseType.GetName()}");
        }
        bool hasBaseType = baseTypeExpression.Length > 0;

        foreach (var interfaceType in _interfaces)
        {
            if (interfaceType.IsSupported())
            {
                if (baseTypeExpression.Length == 0)
                {
                    _ = baseTypeExpression.Append(" : ");
                }
                else
                {
                    _ = baseTypeExpression.Append(", ");
                }
                _ = baseTypeExpression.Append(interfaceType.GetName());
            }
        }

        if (baseTypeExpression.Length == 0)
        {
            _ = baseTypeExpression.Append($" : IWinUIShellObject");
        }

        string abstractExpression = _apiObjectDef.Type.IsAbstract ? "abstract " : "";

        codeWriter.Append($$"""
            public {{abstractExpression}}class {{_apiObjectDef.Name}}{{genericArgumentsExpression}}{{baseTypeExpression}}
            {
            """);
        codeWriter.IncrementIndent();

        if (!hasBaseType)
        {
            codeWriter.AppendAndReserveNewLine($$"""
                public ObjectId WinUIShellObjectId { get; protected set; } = new();
                """);
        }

        bool hasDefaultConstructor = false;
        foreach (var method in _constructors)
        {
            if (!method.IsSupported())
                continue;

            if (method.Parameters.Count == 0)
            {
                hasDefaultConstructor = true;
            }

            if (_apiObjectDef.Type.IsAbstract)
            {
                codeWriter.AppendAndReserveNewLine($$"""
                    {{method.GetConstructorSignatureExpression(_apiObjectDef.Name)}}
                    {
                    }
                    """);
            }
            else
            {
                codeWriter.AppendAndReserveNewLine($$"""
                    {{method.GetConstructorSignatureExpression(_apiObjectDef.Name)}}
                    {
                        WinUIShellObjectId = CommandClient.Get().CreateObject(
                            ObjectTypeMapping.Get().GetTargetTypeName<{{Type.GetName()}}>(),
                            this{{method.GetArgumentsExpression()}});
                    }
                    """);
            }
        }

        if (_apiObjectDef.Type.IsAbstract && !hasDefaultConstructor)
        {
            codeWriter.AppendAndReserveNewLine($$"""
                internal {{_apiObjectDef.Name}}()
                {
                }
                """);
        }

        if (hasBaseType)
        {
            codeWriter.AppendAndReserveNewLine($$"""
                internal {{_apiObjectDef.Name}}(ObjectId id)
                    : base(id)
                {
                }
                """);
        }
        else
        {
            codeWriter.AppendAndReserveNewLine($$"""
                internal {{_apiObjectDef.Name}}(ObjectId id)
                {
                    WinUIShellObjectId = id;
                }
                """);
        }

        foreach (var property in _staticProperties)
        {
            if (!property.IsSupported())
                continue;

            codeWriter.Append($$"""
                {{property.GetSignatureExpression()}}
                {
                """);
            codeWriter.IncrementIndent();

            if (property.CanRead)
            {
                if (property.IsAbstract)
                {
                    codeWriter.Append($$"""
                        get;
                        """);
                }
                else
                {
                    codeWriter.Append($$"""
                        get => PropertyAccessor.GetStatic<{{property.Type.GetReturnInstanceTypeName()}}>(
                            ObjectTypeMapping.Get().GetTargetTypeName<{{Type.GetName()}}>(),
                            nameof({{property.GetName()}})){{(property.Type.IsNullable ? "" : "!")}};
                        """);
                }
            }

            if (property.CanWrite)
            {
                if (property.IsAbstract)
                {
                    codeWriter.Append($$"""
                        set;
                        """);
                }
                else
                {
                    codeWriter.Append($$"""
                        set => PropertyAccessor.SetStatic(
                            ObjectTypeMapping.Get().GetTargetTypeName<{{Type.GetName()}}>(),
                            nameof({{property.GetName()}}),
                            value);
                        """);
                }
            }

            codeWriter.DecrementIndent();
            codeWriter.AppendAndReserveNewLine("}");
        }

        foreach (var property in _instanceProperties)
        {
            if (!property.IsSupported())
                continue;

            codeWriter.Append($$"""
                {{property.GetSignatureExpression()}}
                {
                """);
            codeWriter.IncrementIndent();

            if (property.CanRead)
            {
                if (property.IsAbstract)
                {
                    codeWriter.Append($$"""
                        get;
                        """);
                }
                else
                if (property.IsIndexer)
                {
                    codeWriter.Append($$"""
                        get => PropertyAccessor.GetIndexer<{{property.Type.GetReturnInstanceTypeName()}}>(WinUIShellObjectId{{property.GetIndexerArgumentsExpression()}}){{(property.Type.IsNullable ? "" : "!")}};
                        """);
                }
                else
                {
                    codeWriter.Append($$"""
                        get => PropertyAccessor.Get<{{property.Type.GetReturnInstanceTypeName()}}>(WinUIShellObjectId, nameof({{property.GetName()}})){{(property.Type.IsNullable ? "" : "!")}};
                        """);
                }
            }

            if (property.CanWrite)
            {
                if (property.IsAbstract)
                {
                    codeWriter.Append($$"""
                        set;
                        """);
                }
                else
                if (property.IsIndexer)
                {
                    codeWriter.Append($$"""
                        set => PropertyAccessor.SetIndexer(WinUIShellObjectId{{property.GetIndexerArgumentsExpression()}}, {{property.Type.GetValueExpression()}});
                        """);
                }
                else
                {
                    codeWriter.Append($$"""
                        set => PropertyAccessor.Set(WinUIShellObjectId, nameof({{property.GetName()}}), {{property.Type.GetValueExpression()}});
                        """);
                }
            }

            codeWriter.DecrementIndent();
            codeWriter.AppendAndReserveNewLine("}");
        }

        foreach (var method in _staticMethods)
        {
            if (!method.IsSupported())
                continue;

            var returnType = method.ReturnType!;
            if (method.IsAbstract)
            {
                codeWriter.AppendAndReserveNewLine($$"""
                    {{method.GetSignatureExpression()}};
                    """);
            }
            else
            if (returnType.IsVoid)
            {
                codeWriter.AppendAndReserveNewLine($$"""
                    {{method.GetSignatureExpression()}}
                    {
                        CommandClient.Get().InvokeStaticMethod(
                            ObjectTypeMapping.Get().GetTargetTypeName<{{Type.GetName()}}>(),
                            nameof({{method.GetName()}}){{method.GetArgumentsExpression()}});
                    }
                    """);
            }
            else
            {
                codeWriter.AppendAndReserveNewLine($$"""
                    {{method.GetSignatureExpression()}}
                    {
                        return CommandClient.Get().InvokeStaticMethodAndGetResult<{{returnType.GetReturnInstanceTypeName()}}>(
                            ObjectTypeMapping.Get().GetTargetTypeName<{{Type.GetName()}}>(),
                            nameof({{method.GetName()}}){{method.GetArgumentsExpression()}}){{(returnType.IsNullable ? "" : "!")}};
                    }
                    """);
            }
        }

        foreach (var method in _instanceMethods)
        {
            if (SpecializedMethodGenerator.Generate(codeWriter, method))
                continue;

            if (!method.IsSupported())
                continue;

            var returnType = method.ReturnType!;
            if (method.IsAbstract)
            {
                codeWriter.AppendAndReserveNewLine($$"""
                    {{method.GetSignatureExpression()}};
                    """);
            }
            else
            if (returnType.IsVoid)
            {
                codeWriter.AppendAndReserveNewLine($$"""
                    {{method.GetSignatureExpression()}}
                    {
                        CommandClient.Get().InvokeMethod(
                            WinUIShellObjectId,
                            nameof({{method.GetName()}}){{method.GetArgumentsExpression()}});
                    }
                    """);
            }
            else
            {
                codeWriter.AppendAndReserveNewLine($$"""
                    {{method.GetSignatureExpression()}}
                    {
                        return CommandClient.Get().InvokeMethodAndGetResult<{{returnType.GetReturnInstanceTypeName()}}>(
                            WinUIShellObjectId,
                            nameof({{method.GetName()}}){{method.GetArgumentsExpression()}}){{(returnType.IsNullable ? "" : "!")}};
                    }
                    """);
            }
        }

        foreach (var nestedObject in _nestedObjects)
        {
            nestedObject.Generate(codeWriter);
        }

        codeWriter.DecrementIndent();
        codeWriter.AppendAndReserveNewLine("}");
    }

    // When properties or methods return an object with its interface type, and if we don't have the corresponding object type on the client side,
    // we have to create an accessor object that implements the interface. This function generates such implementation classes.
    private void GenerateInterfaceImpl(CodeWriter codeWriter)
    {
        string genericArgumentsExpression = Type.GetGenericArgumentsExpression(_parentObjectDef?.Type.GenericArguments);
        string baseTypeExpression = $" : {_apiObjectDef.Name}{genericArgumentsExpression}";
        string className = $"{_apiObjectDef.Name}Impl";

        codeWriter.Append($$"""
            public class {{className}}{{genericArgumentsExpression}}{{baseTypeExpression}}
            {
            """);
        codeWriter.IncrementIndent();

        codeWriter.AppendAndReserveNewLine($$"""
            public ObjectId WinUIShellObjectId { get; protected set; } = new();
            """);

        codeWriter.AppendAndReserveNewLine($$"""
            internal {{className}}(ObjectId id)
            {
                WinUIShellObjectId = id;
            }
            """);

        SignatureStore signatureStore = new();
        GenerateInterfaceImplBody(codeWriter, className, Type.GenericArguments, signatureStore);

        codeWriter.DecrementIndent();
        codeWriter.AppendAndReserveNewLine("}");
    }

    private void GenerateInterfaceImplBody(CodeWriter codeWriter, string rootClassName, List<TypeDef>? genericTypeParametersOverride, SignatureStore signatureStore)
    {
        if (signatureStore.ContainsObject(this))
            return;

        foreach (var property in _staticProperties)
        {
            if (!property.IsSupported())
                continue;

            bool isExplicit = signatureStore.ContainsSignature(property);

            codeWriter.Append($$"""
                {{property.GetInterfaceImplSignatureExpression(isExplicit, genericTypeParametersOverride)}}
                {
                """);
            codeWriter.IncrementIndent();

            if (property.CanRead)
            {
                codeWriter.Append($$"""
                    get => PropertyAccessor.GetStatic<{{property.Type.GetReturnInstanceTypeName()}}>(
                        ObjectTypeMapping.Get().GetTargetTypeName<{{rootClassName}}>(),
                        nameof({{property.GetName()}})){{(property.Type.IsNullable ? "" : "!")}};
                    """);
            }

            if (property.CanWrite)
            {
                codeWriter.Append($$"""
                    set => PropertyAccessor.SetStatic(
                        ObjectTypeMapping.Get().GetTargetTypeName<{{rootClassName}}>(),
                        nameof({{property.GetName()}}),
                        value);
                    """);
            }

            codeWriter.DecrementIndent();
            codeWriter.AppendAndReserveNewLine("}");
        }

        foreach (var property in _instanceProperties)
        {
            if (!property.IsSupported())
                continue;

            bool isExplicit = signatureStore.ContainsSignature(property);

            codeWriter.Append($$"""
                {{property.GetInterfaceImplSignatureExpression(isExplicit, genericTypeParametersOverride)}}
                {
                """);
            codeWriter.IncrementIndent();

            if (property.CanRead)
            {
                if (property.IsIndexer)
                {
                    codeWriter.Append($$"""
                        get => PropertyAccessor.GetIndexer<{{property.Type.GetReturnInstanceTypeName()}}>(WinUIShellObjectId{{property.GetIndexerArgumentsExpression()}}){{(property.Type.IsNullable ? "" : "!")}};
                        """);
                }
                else
                {
                    codeWriter.Append($$"""
                        get => PropertyAccessor.Get<{{property.Type.GetReturnInstanceTypeName()}}>(WinUIShellObjectId, nameof({{property.GetName()}})){{(property.Type.IsNullable ? "" : "!")}};
                        """);
                }
            }

            if (property.CanWrite)
            {
                if (property.IsIndexer)
                {
                    codeWriter.Append($$"""
                        set => PropertyAccessor.SetIndexer(WinUIShellObjectId{{property.GetIndexerArgumentsExpression()}}, {{property.Type.GetValueExpression()}});
                        """);
                }
                else
                {
                    codeWriter.Append($$"""
                        set => PropertyAccessor.Set(WinUIShellObjectId, nameof({{property.GetName()}}), {{property.Type.GetValueExpression()}});
                        """);
                }
            }

            codeWriter.DecrementIndent();
            codeWriter.AppendAndReserveNewLine("}");
        }

        foreach (var method in _staticMethods)
        {
            if (!method.IsSupported())
                continue;

            bool isExplicit = signatureStore.ContainsSignature(method);

            var returnType = method.ReturnType!.OverrideGenericTypeParameter(genericTypeParametersOverride);
            if (returnType.IsVoid)
            {
                codeWriter.AppendAndReserveNewLine($$"""
                    {{method.GetInterfaceImplSignatureExpression(isExplicit, genericTypeParametersOverride)}}
                    {
                        CommandClient.Get().InvokeStaticMethod(
                            ObjectTypeMapping.Get().GetTargetTypeName<{{rootClassName}}>(),
                            nameof({{method.GetName()}}){{method.GetArgumentsExpression()}});
                    }
                    """);
            }
            else
            {
                codeWriter.AppendAndReserveNewLine($$"""
                    {{method.GetInterfaceImplSignatureExpression(isExplicit, genericTypeParametersOverride)}}
                    {
                        return CommandClient.Get().InvokeStaticMethodAndGetResult<{{returnType.GetReturnInstanceTypeName()}}>(
                            ObjectTypeMapping.Get().GetTargetTypeName<{{rootClassName}}>(),
                            nameof({{method.GetName()}}){{method.GetArgumentsExpression()}}){{(returnType.IsNullable ? "" : "!")}};
                    }
                    """);
            }
        }

        foreach (var method in _instanceMethods)
        {
            if (SpecializedMethodGenerator.GenerateForInterfaceImpl(codeWriter, method, genericTypeParametersOverride, signatureStore))
                continue;

            if (!method.IsSupported())
                continue;

            bool isExplicit = signatureStore.ContainsSignature(method);

            var returnType = method.ReturnType!.OverrideGenericTypeParameter(genericTypeParametersOverride);
            if (returnType.IsVoid)
            {
                codeWriter.AppendAndReserveNewLine($$"""
                    {{method.GetInterfaceImplSignatureExpression(isExplicit, genericTypeParametersOverride)}}
                    {
                        CommandClient.Get().InvokeMethod(
                            WinUIShellObjectId,
                            nameof({{method.GetName()}}){{method.GetArgumentsExpression()}});
                    }
                    """);
            }
            else
            {
                codeWriter.AppendAndReserveNewLine($$"""
                    {{method.GetInterfaceImplSignatureExpression(isExplicit, genericTypeParametersOverride)}}
                    {
                        return CommandClient.Get().InvokeMethodAndGetResult<{{returnType.GetReturnInstanceTypeName()}}>(
                            WinUIShellObjectId,
                            nameof({{method.GetName()}}){{method.GetArgumentsExpression()}}){{(returnType.IsNullable ? "" : "!")}};
                    }
                    """);
            }
        }

        signatureStore.AddObjectDef(this);

        foreach (var interfaceType in _interfaces)
        {
            if (!interfaceType.IsSupported())
                continue;

            ObjectDef? interfaceObject = ObjectGenerator.GetObjectDef(interfaceType);
            if (interfaceObject is null)
                continue;

            TypeDef overridenInterfaceType = interfaceType.OverrideGenericTypeParameter(genericTypeParametersOverride);

            interfaceObject.GenerateInterfaceImplBody(
                codeWriter,
                rootClassName,
                overridenInterfaceType.GenericArguments,
                signatureStore);
        }
    }
}
