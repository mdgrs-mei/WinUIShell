using System.Text;
using WinUIShell.Server;

namespace WinUIShell.Generator;

internal class ObjectDef
{
    private readonly Api.ObjectDef _apiObjectDef;
    private readonly TypeDef _type;
    private readonly TypeDef? _baseType;

    private readonly List<TypeDef> _interfaces = [];
    private readonly List<PropertyDef> _staticProperties = [];
    private readonly List<PropertyDef> _instanceProperties = [];
    private readonly List<Method> _constructors = [];
    private readonly List<Method> _staticMethods = [];
    private readonly List<Method> _instanceMethods = [];

    public ObjectDef(Api.ObjectDef apiObjectDef)
    {
        _apiObjectDef = apiObjectDef;
        _type = new TypeDef(_apiObjectDef.Type);
        if (_apiObjectDef.BaseType is not null)
        {
            _baseType = new TypeDef(_apiObjectDef.BaseType);
        }

        foreach (var interfaceType in _apiObjectDef.Interfaces)
        {
            _interfaces.Add(new TypeDef(interfaceType));
        }
        foreach (var property in _apiObjectDef.StaticProperties)
        {
            _staticProperties.Add(new PropertyDef(property));
        }
        foreach (var property in _apiObjectDef.InstanceProperties)
        {
            _instanceProperties.Add(new PropertyDef(property));
        }
        foreach (var constructor in _apiObjectDef.Constructors)
        {
            _constructors.Add(new Method(constructor, _apiObjectDef));
        }
        foreach (var method in _apiObjectDef.StaticMethods)
        {
            _staticMethods.Add(new Method(method, _apiObjectDef));
        }
        foreach (var method in _apiObjectDef.InstanceMethods)
        {
            _instanceMethods.Add(new Method(method, _apiObjectDef));
        }
    }

    public bool IsSupported()
    {
        return true;
    }

    public string GetSourceCodeFileName()
    {
        return $"WinUIShell.{_apiObjectDef.Namespace}.{_apiObjectDef.Name}.g.cs";
    }

    public string Generate()
    {
        StringBuilder sourceCode = new();

        var ns = Generator.GetTargetNamespace(_apiObjectDef.Namespace);

        _ = sourceCode.Append($$"""
                // <auto-generated/>
                #nullable enable

                using WinUIShell;
                using WinUIShell.Common;

                namespace {{ns}};


                """);

        if (_type.IsInterface)
        {
            GenerateInterface(sourceCode);
        }
        else
        {
            GenerateClass(sourceCode);
        }

        return sourceCode.ToString();
    }

    private void GenerateInterface(StringBuilder sourceCode)
    {
        string genericParameterExpression = "";
        if (_apiObjectDef.Type.GenericTypeArguments.Count > 0)
        {
            var genericParameterNames = _apiObjectDef.Type.GenericTypeArguments.Select(t => t.Name);
            genericParameterExpression = $"<{string.Join(", ", genericParameterNames)}>";
        }

        bool isSystemInterface = _apiObjectDef.Type.IsInterface && _apiObjectDef.Namespace.StartsWith("System.");
        StringBuilder baseTypeExpression = new(isSystemInterface ? $" : global::{_apiObjectDef.Namespace}.{_apiObjectDef.Name}{genericParameterExpression}" : "");
        foreach (var interfaceType in _apiObjectDef.Interfaces)
        {
            var type = new TypeDef(interfaceType);
            if (type.IsSupported())
            {
                if (baseTypeExpression.Length == 0)
                {
                    _ = baseTypeExpression.Append(" : ");
                }
                else
                {
                    _ = baseTypeExpression.Append(", ");
                }
                _ = baseTypeExpression.Append(type.GetName());
            }
        }

        _ = sourceCode.Append($$"""
            public interface {{_apiObjectDef.Name}}{{genericParameterExpression}}{{baseTypeExpression}}
            {
            """);

        if (!isSystemInterface)
        {
            foreach (var constructorDef in _apiObjectDef.Constructors)
            {
                var method = new Method(constructorDef, _apiObjectDef);
                if (!method.IsSupported())
                    continue;

                _ = sourceCode.Append($$"""

                        public {{_apiObjectDef.Name}}({{method.GetParametersExpression()}});

                    """);
            }

            foreach (var property in _apiObjectDef.StaticProperties)
            {
                var propertyType = new TypeDef(property.Type);
                if (!propertyType.IsSupported())
                    continue;

                _ = sourceCode.Append($$"""

                        public static {{propertyType.GetTypeExpression()}} {{property.Name}}
                        {

                    """);

                if (property.CanRead)
                {
                    _ = sourceCode.Append($$"""
                                get;

                        """);
                }

                if (property.CanWrite)
                {
                    _ = sourceCode.Append($$"""
                                set;

                        """);
                }

                _ = sourceCode.Append("    }\r\n");
            }

            foreach (var property in _apiObjectDef.InstanceProperties)
            {
                var propertyType = new TypeDef(property.Type);
                if (!propertyType.IsSupported())
                    continue;

                _ = sourceCode.Append($$"""

                        public {{propertyType.GetTypeExpression()}} {{property.Name}}
                        {

                    """);

                if (property.CanRead)
                {
                    _ = sourceCode.Append($$"""
                                get;

                        """);
                }

                if (property.CanWrite)
                {
                    _ = sourceCode.Append($$"""
                                set;

                        """);
                }

                _ = sourceCode.Append("    }\r\n");
            }

            foreach (var methodDef in _apiObjectDef.StaticMethods)
            {
                var method = new Method(methodDef, _apiObjectDef);
                if (!method.IsSupported())
                    continue;

                _ = sourceCode.Append($$"""

                        public static {{method.GetSignatureExpression()}};

                    """);
            }

            foreach (var methodDef in _apiObjectDef.InstanceMethods)
            {
                var method = new Method(methodDef, _apiObjectDef);
                if (!method.IsSupported())
                    continue;

                _ = sourceCode.Append($$"""

                        public {{method.GetSignatureExpression()}};

                    """);
            }
        }
        _ = sourceCode.Append("}\r\n");
    }

    private void GenerateClass(StringBuilder sourceCode)
    {
        string genericParameterExpression = "";
        if (_apiObjectDef.Type.GenericTypeArguments.Count > 0)
        {
            var genericParameterNames = _apiObjectDef.Type.GenericTypeArguments.Select(t => t.Name);
            genericParameterExpression = $"<{string.Join(", ", genericParameterNames)}>";
        }

        StringBuilder baseTypeExpression = new(" : WinUIShellObject");
        if (_apiObjectDef.BaseType is not null)
        {
            var type = new TypeDef(_apiObjectDef.BaseType);
            if (type.IsSupported())
            {
                _ = baseTypeExpression.Append($", {type.GetName()}");
            }
        }
        foreach (var interfaceType in _apiObjectDef.Interfaces)
        {
            var type = new TypeDef(interfaceType);
            if (type.IsSupported())
            {
                _ = baseTypeExpression.Append($", {type.GetName()}");
            }
        }

        _ = sourceCode.Append($$"""
            public class {{_apiObjectDef.Name}}{{genericParameterExpression}}{{baseTypeExpression}}
            {
                internal {{_apiObjectDef.Name}}(ObjectId id)
                    : base(id)
                {
                }

            """);


        foreach (var constructorDef in _apiObjectDef.Constructors)
        {
            var method = new Method(constructorDef, _apiObjectDef);
            if (!method.IsSupported())
                continue;

            _ = sourceCode.Append($$"""

                    public {{_apiObjectDef.Name}}({{method.GetParametersExpression()}})
                    {
                        Id = CommandClient.Get().CreateObject(
                            ObjectTypeMapping.Get().GetTargetTypeName<{{_apiObjectDef.Name}}>(),
                            this{{method.GetArgumentsExpression()}});
                    }

                """);
        }

        foreach (var property in _apiObjectDef.StaticProperties)
        {
            var propertyType = new TypeDef(property.Type);
            if (!propertyType.IsSupported())
                continue;

            _ = sourceCode.Append($$"""

                    public static {{propertyType.GetTypeExpression()}} {{property.Name}}
                    {

                """);

            if (property.CanRead)
            {
                _ = sourceCode.Append($$"""
                            get => PropertyAccessor.GetStatic<{{propertyType.GetName()}}>(
                                ObjectTypeMapping.Get().GetTargetTypeName<{{_apiObjectDef.Name}}>(),
                                nameof({{property.Name}})){{(propertyType.IsNullable ? "" : "!")}};

                    """);
            }

            if (property.CanWrite)
            {
                _ = sourceCode.Append($$"""
                            set => PropertyAccessor.SetStatic(
                                ObjectTypeMapping.Get().GetTargetTypeName<{{_apiObjectDef.Name}}>(),
                                nameof({{property.Name}}),
                                value);

                    """);
            }

            _ = sourceCode.Append("    }\r\n");
        }

        foreach (var property in _apiObjectDef.InstanceProperties)
        {
            var propertyType = new TypeDef(property.Type);
            if (!propertyType.IsSupported())
                continue;

            _ = sourceCode.Append($$"""

                    public {{propertyType.GetTypeExpression()}} {{property.Name}}
                    {

                """);

            if (property.CanRead)
            {
                _ = sourceCode.Append($$"""
                            get => PropertyAccessor.Get<{{propertyType.GetName()}}>(Id, nameof({{property.Name}})){{(propertyType.IsNullable ? "" : "!")}};

                    """);
            }

            if (property.CanWrite)
            {
                _ = sourceCode.Append($$"""
                            set => PropertyAccessor.Set(Id, nameof({{property.Name}}), {{propertyType.GetValueExpression()}});

                    """);
            }

            _ = sourceCode.Append("    }\r\n");
        }

        foreach (var methodDef in _apiObjectDef.StaticMethods)
        {
            var method = new Method(methodDef, _apiObjectDef);
            if (!method.IsSupported())
                continue;

            var returnType = method.ReturnType!;
            if (returnType.IsVoid)
            {
                _ = sourceCode.Append($$"""

                        public static {{method.GetSignatureExpression()}}
                        {
                            CommandClient.Get().InvokeStaticMethod(
                                ObjectTypeMapping.Get().GetTargetTypeName<{{_apiObjectDef.Name}}>(),
                                nameof({{method.GetName()}}){{method.GetArgumentsExpression()}});
                        }

                    """);
            }
            else
            {
                _ = sourceCode.Append($$"""

                        public static {{method.GetSignatureExpression()}}
                        {
                            return CommandClient.Get().InvokeStaticMethodAndGetResult<{{returnType.GetName()}}>(
                                ObjectTypeMapping.Get().GetTargetTypeName<{{_apiObjectDef.Name}}>(),
                                nameof({{method.GetName()}}){{method.GetArgumentsExpression()}}){{(returnType.IsNullable ? "" : "!")}};
                        }

                    """);
            }
        }

        foreach (var methodDef in _apiObjectDef.InstanceMethods)
        {
            var method = new Method(methodDef, _apiObjectDef);
            if (!method.IsSupported())
                continue;

            var returnType = method.ReturnType!;
            if (returnType.IsVoid)
            {
                _ = sourceCode.Append($$"""

                        public {{method.GetSignatureExpression()}}
                        {
                            CommandClient.Get().InvokeMethod(
                                Id,
                                nameof({{method.GetName()}}){{method.GetArgumentsExpression()}});
                        }

                    """);
            }
            else
            {
                _ = sourceCode.Append($$"""

                        public {{method.GetSignatureExpression()}}
                        {
                            return CommandClient.Get().InvokeMethodAndGetResult<{{returnType.GetName()}}>(
                                Id,
                                nameof({{method.GetName()}}){{method.GetArgumentsExpression()}}){{(returnType.IsNullable ? "" : "!")}};
                        }

                    """);
            }
        }

        _ = sourceCode.Append("}\r\n");
    }
}
