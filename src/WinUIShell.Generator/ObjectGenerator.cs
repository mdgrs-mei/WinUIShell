using System.Text;
using Microsoft.CodeAnalysis;
using WinUIShell.Server;

namespace WinUIShell.Generator;

internal static class ObjectGenerator
{
    public static void Generate(SourceProductionContext sourceProductionContext, Api api)
    {
        foreach (var objectDef in api.Objects)
        {
            StringBuilder sourceCode = new();

            var ns = Generator.GetTargetNamespace(objectDef.Namespace);

            _ = sourceCode.Append($$"""
                // <auto-generated/>
                #nullable enable

                using WinUIShell;
                using WinUIShell.Common;

                namespace {{ns}};

                public class {{objectDef.Name}} : WinUIShellObject
                {
                    internal {{objectDef.Name}}(ObjectId id)
                      : base(id)
                    {
                    }

                """);

            foreach (var constructor in objectDef.Constructors)
            {
                _ = sourceCode.Append($$"""

                        public {{objectDef.Name}}(
                    """);


                string commaSpace = "";
                foreach (var parameter in constructor.Parameters)
                {
                    var parameterType = new ArgumentType(parameter.Type);
                    _ = sourceCode.Append($"{commaSpace}{parameterType.GetTypeExpression()} {parameter.Name}");
                    commaSpace = ", ";
                }

                _ = sourceCode.Append($$"""
                    )
                        {
                            Id = CommandClient.Get().CreateObject(
                                ObjectTypeMapping.Get().GetTargetTypeName<{{objectDef.Name}}>(),
                                this
                    """);

                foreach (var parameter in constructor.Parameters)
                {
                    _ = sourceCode.Append($",\r\n            {parameter.Name}");
                }
                _ = sourceCode.Append($$"""
                    );
                        }

                    """);
            }

            foreach (var property in objectDef.StaticProperties)
            {
                var propertyType = new ArgumentType(property.Type);
                if (!propertyType.IsSupported)
                    continue;

                _ = sourceCode.Append($$"""

                        public static {{propertyType.GetTypeExpression()}} {{property.Name}}
                        {

                    """);

                if (property.CanRead)
                {
                    _ = sourceCode.Append($$"""
                                get => PropertyAccessor.GetStatic<{{propertyType.GetName()}}>(
                                    ObjectTypeMapping.Get().GetTargetTypeName<{{objectDef.Name}}>(),
                                    nameof({{property.Name}})){{(propertyType.IsNullable ? "" : "!")}};

                        """);
                }

                if (property.CanWrite)
                {
                    _ = sourceCode.Append($$"""
                                set => PropertyAccessor.SetStatic(
                                    ObjectTypeMapping.Get().GetTargetTypeName<{{objectDef.Name}}>(),
                                    nameof({{property.Name}}),
                                    value);

                        """);
                }

                _ = sourceCode.Append("    }\r\n");
            }

            foreach (var property in objectDef.InstanceProperties)
            {
                var propertyType = new ArgumentType(property.Type);
                if (!propertyType.IsSupported)
                    continue;

                _ = sourceCode.Append($$"""

                        public {{propertyType.GetTypeExpression()}} {{property.Name}}
                        {

                    """);

                if (property.CanRead)
                {
                    _ = sourceCode.Append($$"""
                                get => PropertyAccessor.Get<{{propertyType.GetName()}}>(Id, nameof({{property.Name}})){{(propertyType.IsNullable ? "" : "!")}};

                        """);
                }

                if (property.CanWrite)
                {
                    _ = sourceCode.Append($$"""
                                set => PropertyAccessor.Set(Id, nameof({{property.Name}}), {{propertyType.GetValueExpression()}});

                        """);
                }

                _ = sourceCode.Append("    }\r\n");
            }

            foreach (var method in objectDef.StaticMethods)
            {
                if (!IsParametersAllSupported(method.Parameters))
                    continue;

                var returnType = new ArgumentType(method.ReturnType!);
                if (returnType.IsVoid)
                {
                    _ = sourceCode.Append($$"""

                        public static void {{method.Name}}({{GetParametersExpression(method.Parameters)}})
                        {
                            CommandClient.Get().InvokeStaticMethod(
                                ObjectTypeMapping.Get().GetTargetTypeName<{{objectDef.Name}}>(),
                                nameof({{method.Name}}){{GetArgumentsExpression(method.Parameters)}});
                        }

                    """);
                }
                else
                {
                    _ = sourceCode.Append($$"""

                        public static {{returnType.GetTypeExpression()}} {{method.Name}}({{GetParametersExpression(method.Parameters)}})
                        {
                            return CommandClient.Get().InvokeStaticMethodAndGetResult<{{returnType.GetName()}}>(
                                ObjectTypeMapping.Get().GetTargetTypeName<{{objectDef.Name}}>(),
                                nameof({{method.Name}}){{GetArgumentsExpression(method.Parameters)}});
                        }

                    """);
                }
            }

            _ = sourceCode.Append("}\r\n");

            sourceProductionContext.AddSource($"WinUIShell.{objectDef.Namespace}.{objectDef.Name}.g.cs", sourceCode.ToString());
        }
    }

    private static string GetParametersExpression(List<Api.ParameterDef> parameters)
    {
        StringBuilder builder = new();
        string commaSpace = "";
        foreach (var parameter in parameters)
        {
            var parameterType = new ArgumentType(parameter.Type);
            _ = builder.Append($"{commaSpace}{parameterType.GetTypeExpression()} {parameter.Name}");
            commaSpace = ", ";
        }
        return builder.ToString();
    }

    private static string GetArgumentsExpression(List<Api.ParameterDef> parameters)
    {
        StringBuilder builder = new();
        foreach (var parameter in parameters)
        {
            _ = builder.Append($", {parameter.Name}");
        }
        return builder.ToString();
    }

    private static bool IsParametersAllSupported(List<Api.ParameterDef> parameters)
    {
        foreach (var parameter in parameters)
        {
            var parameterType = new ArgumentType(parameter.Type);
            if (!parameterType.IsSupported)
                return false;
        }
        return true;
    }
}
